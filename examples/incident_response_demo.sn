// Incident Response Automation Demo
log("ğŸš¨ Sentra Incident Response Automation")
log("=" * 50)

// Create a security incident
log("\nğŸ“‹ Creating Security Incident...")
let incident = ir_create_incident(
    "Malware Detection on Workstation", 
    "Suspicious malware activity detected on user workstation WS-001",
    "high",
    "endpoint_detection"
)
log("â€¢ Incident created: " + incident["id"])
log("â€¢ Title: " + incident["title"])
log("â€¢ Severity: " + incident["severity"])
log("â€¢ Status: " + incident["status"])
log("â€¢ Created: " + incident["created_at"])

let incident_id = incident["id"]

// Collect evidence
log("\nğŸ” Collecting Evidence...")
ir_collect_evidence(incident_id, "file_hash", "e3b0c44298fc1c149afbf4c8996fb924", "antivirus")
ir_collect_evidence(incident_id, "ip_address", "192.168.1.50", "network_monitor")
ir_collect_evidence(incident_id, "process_name", "suspicious.exe", "endpoint_agent")
log("â€¢ Evidence collection completed")

// Update incident with additional details
log("\nğŸ“ Updating Incident...")
let updates = {
    "category": "malware",
    "assigned_to": "security_analyst_1"
}
ir_update_incident(incident_id, updates)
log("â€¢ Incident updated with category and assignment")

// List available playbooks and get the malware response playbook ID
log("\nğŸ“– Available Playbooks...")
let playbooks = ir_list_playbooks()
log("â€¢ Total playbooks: " + len(playbooks))

let malware_playbook_id = ""
for playbook in playbooks {
    log("  - " + playbook["id"] + ": " + playbook["name"] + " (" + playbook["category"] + ")")
    // Use first available playbook if no malware-specific one exists
    if malware_playbook_id == "" {
        malware_playbook_id = playbook["id"]
    }
    if playbook["category"] == "malware" {
        malware_playbook_id = playbook["id"]
    }
}

// Execute malware response playbook
log("\nğŸ¯ Executing Malware Response Playbook...")
let playbook_response = ir_execute_playbook(incident_id, malware_playbook_id)
log("â€¢ Playbook executed: " + playbook_response["action"])
log("â€¢ Status: " + playbook_response["status"])
log("â€¢ Message: " + playbook_response["message"])
log("â€¢ Evidence collected: " + len(playbook_response["evidence"]) + " items")
log("â€¢ Next steps: " + len(playbook_response["next_steps"]) + " actions")

// Execute specific response action
log("\nâš¡ Executing Response Action...")
let action_params = {"host": "WS-001"}
let action_response = ir_execute_action(incident_id, "RA-001", action_params)
log("â€¢ Action: " + action_response["action"])
log("â€¢ Status: " + action_response["status"])
log("â€¢ Message: " + action_response["message"])

// Get detailed incident information
log("\nğŸ“Š Incident Details...")
let detailed_incident = ir_get_incident(incident_id)
log("â€¢ ID: " + detailed_incident["id"])
log("â€¢ Title: " + detailed_incident["title"])
log("â€¢ Category: " + detailed_incident["category"])
log("â€¢ Assigned to: " + detailed_incident["assigned_to"])
log("â€¢ Artifacts collected: " + len(detailed_incident["artifacts"]))
log("â€¢ Timeline events: " + len(detailed_incident["timeline"]))
log("â€¢ Actions executed: " + len(detailed_incident["actions"]))

// Create a second incident for demonstration
log("\nğŸ”´ Creating Another Incident...")
let incident2 = ir_create_incident(
    "Network Intrusion Attempt",
    "Multiple failed login attempts detected from external IP",
    "medium", 
    "siem_system"
)
log("â€¢ Second incident created: " + incident2["id"])

// List all incidents
log("\nğŸ“‹ Listing All Incidents...")
let all_incidents = ir_list_incidents({})
log("â€¢ Total incidents: " + len(all_incidents))
for incident in all_incidents {
    log("  - " + incident["id"] + ": " + incident["title"] + " (" + incident["severity"] + ")")
}

// Filter incidents by severity
log("\nğŸ” Filtering High Severity Incidents...")
let high_incidents = ir_list_incidents({"severity": "high"})
log("â€¢ High severity incidents: " + len(high_incidents))

// Create a custom playbook
log("\nğŸ“– Creating Custom Playbook...")
let custom_steps = [
    {
        "name": "Isolate System", 
        "description": "Immediately isolate the affected system",
        "action": "isolate_host"
    },
    {
        "name": "Collect Forensics",
        "description": "Collect forensic evidence from the system", 
        "action": "collect_logs"
    },
    {
        "name": "Notify Management",
        "description": "Notify management of the incident",
        "action": "notify_team"
    }
]

let custom_playbook = ir_create_playbook(
    "Custom Data Breach Response",
    "Custom playbook for data breach incidents", 
    "data_breach",
    custom_steps
)
log("â€¢ Custom playbook created: " + custom_playbook["id"])
log("â€¢ Name: " + custom_playbook["name"])
log("â€¢ Category: " + custom_playbook["category"])

// Get incident metrics
log("\nğŸ“ˆ Incident Metrics...")
let metrics = ir_get_metrics()
log("â€¢ Total incidents: " + metrics["total_incidents"])
log("â€¢ Open incidents: " + metrics["open_incidents"])
log("â€¢ Closed incidents: " + metrics["closed_incidents"])
log("â€¢ Critical incidents: " + metrics["critical_incidents"])
log("â€¢ High incidents: " + metrics["high_incidents"])
log("â€¢ Medium incidents: " + metrics["medium_incidents"])
log("â€¢ Low incidents: " + metrics["low_incidents"])

// Close the first incident
log("\nâœ… Closing Incident...")
ir_close_incident(incident_id, "Malware removed, system cleaned, security measures updated")
log("â€¢ Incident " + incident_id + " has been closed")

// Final metrics after closure
log("\nğŸ“Š Final Metrics...")
let final_metrics = ir_get_metrics()
log("â€¢ Open incidents: " + final_metrics["open_incidents"])
log("â€¢ Closed incidents: " + final_metrics["closed_incidents"])

log("\n" + "=" * 50)
log("ğŸ¯ Incident Response Automation Complete!")
log("=" * 50)

log("\nğŸ›¡ï¸ Incident Response Capabilities:")
log("â€¢ Automated incident creation and tracking")
log("â€¢ Evidence collection and chain of custody")
log("â€¢ Playbook-driven response automation")
log("â€¢ Real-time incident timeline tracking")
log("â€¢ Comprehensive metrics and reporting")
log("â€¢ Custom playbook creation and execution")

log("\nâœ… All incident response features operational!")
log("ğŸš€ Ready for automated security incident handling!")