// Incident Response Automation Demo
log("Sentra Incident Response Automation")
log("==================================================")

// Create a security incident
log("")
log("Creating Security Incident...")
let incident = ir_create_incident(
    "Malware Detection on Workstation", 
    "Suspicious malware activity detected on user workstation WS-001",
    "high",
    "endpoint_detection"
)
log("‚Ä¢ Incident created: " + incident["id"])
log("‚Ä¢ Title: " + incident["title"])
log("‚Ä¢ Severity: " + incident["severity"])
log("‚Ä¢ Status: " + incident["status"])
log("‚Ä¢ Created: " + incident["created_at"])

let incident_id = incident["id"]

// Collect evidence
log("\nüîç Collecting Evidence...")
ir_collect_evidence(incident_id, "file_hash", "e3b0c44298fc1c149afbf4c8996fb924", "antivirus")
ir_collect_evidence(incident_id, "ip_address", "192.168.1.50", "network_monitor")
ir_collect_evidence(incident_id, "process_name", "suspicious.exe", "endpoint_agent")
log("‚Ä¢ Evidence collection completed")

// Update incident with additional details
log("\nüìù Updating Incident...")
let updates = {
    "category": "malware",
    "assigned_to": "security_analyst_1"
}
ir_update_incident(incident_id, updates)
log("‚Ä¢ Incident updated with category and assignment")

// List available playbooks and get the malware response playbook ID
log("\nüìñ Available Playbooks...")
let playbooks = ir_list_playbooks()
log("‚Ä¢ Total playbooks: " + len(playbooks))

let malware_playbook_id = ""
for playbook in playbooks {
    log("  - " + playbook["id"] + ": " + playbook["name"] + " (" + playbook["category"] + ")")
    // Use first available playbook if no malware-specific one exists
    if malware_playbook_id == "" {
        malware_playbook_id = playbook["id"]
    }
    if playbook["category"] == "malware" {
        malware_playbook_id = playbook["id"]
    }
}

// Execute malware response playbook
log("\nüéØ Executing Malware Response Playbook...")
let playbook_response = ir_execute_playbook(incident_id, malware_playbook_id)
log("‚Ä¢ Playbook executed: " + playbook_response["action"])
log("‚Ä¢ Status: " + playbook_response["status"])
log("‚Ä¢ Message: " + playbook_response["message"])
log("‚Ä¢ Evidence collected: " + len(playbook_response["evidence"]) + " items")
log("‚Ä¢ Next steps: " + len(playbook_response["next_steps"]) + " actions")

// Execute specific response action
log("\n‚ö° Executing Response Action...")
let action_params = {"host": "WS-001"}
let action_response = ir_execute_action(incident_id, "RA-001", action_params)
log("‚Ä¢ Action: " + action_response["action"])
log("‚Ä¢ Status: " + action_response["status"])
log("‚Ä¢ Message: " + action_response["message"])

// Get detailed incident information
log("\nüìä Incident Details...")
let detailed_incident = ir_get_incident(incident_id)
log("‚Ä¢ ID: " + detailed_incident["id"])
log("‚Ä¢ Title: " + detailed_incident["title"])
log("‚Ä¢ Category: " + detailed_incident["category"])
log("‚Ä¢ Assigned to: " + detailed_incident["assigned_to"])
log("‚Ä¢ Artifacts collected: " + len(detailed_incident["artifacts"]))
log("‚Ä¢ Timeline events: " + len(detailed_incident["timeline"]))
log("‚Ä¢ Actions executed: " + len(detailed_incident["actions"]))

// Create a second incident for demonstration
log("\nüî¥ Creating Another Incident...")
let incident2 = ir_create_incident(
    "Network Intrusion Attempt",
    "Multiple failed login attempts detected from external IP",
    "medium", 
    "siem_system"
)
log("‚Ä¢ Second incident created: " + incident2["id"])

// List all incidents
log("\nüìã Listing All Incidents...")
let all_incidents = ir_list_incidents({})
log("‚Ä¢ Total incidents: " + len(all_incidents))
for incident in all_incidents {
    log("  - " + incident["id"] + ": " + incident["title"] + " (" + incident["severity"] + ")")
}

// Filter incidents by severity
log("\nüîç Filtering High Severity Incidents...")
let high_incidents = ir_list_incidents({"severity": "high"})
log("‚Ä¢ High severity incidents: " + len(high_incidents))

// Create a custom playbook
log("\nüìñ Creating Custom Playbook...")
let custom_steps = [
    {
        "name": "Isolate System", 
        "description": "Immediately isolate the affected system",
        "action": "isolate_host"
    },
    {
        "name": "Collect Forensics",
        "description": "Collect forensic evidence from the system", 
        "action": "collect_logs"
    },
    {
        "name": "Notify Management",
        "description": "Notify management of the incident",
        "action": "notify_team"
    }
]

let custom_playbook = ir_create_playbook(
    "Custom Data Breach Response",
    "Custom playbook for data breach incidents", 
    "data_breach",
    custom_steps
)
log("‚Ä¢ Custom playbook created: " + custom_playbook["id"])
log("‚Ä¢ Name: " + custom_playbook["name"])
log("‚Ä¢ Category: " + custom_playbook["category"])

// Get incident metrics
log("\nüìà Incident Metrics...")
let metrics = ir_get_metrics()
log("‚Ä¢ Total incidents: " + metrics["total_incidents"])
log("‚Ä¢ Open incidents: " + metrics["open_incidents"])
log("‚Ä¢ Closed incidents: " + metrics["closed_incidents"])
log("‚Ä¢ Critical incidents: " + metrics["critical_incidents"])
log("‚Ä¢ High incidents: " + metrics["high_incidents"])
log("‚Ä¢ Medium incidents: " + metrics["medium_incidents"])
log("‚Ä¢ Low incidents: " + metrics["low_incidents"])

// Close the first incident
log("\n‚úÖ Closing Incident...")
ir_close_incident(incident_id, "Malware removed, system cleaned, security measures updated")
log("‚Ä¢ Incident " + incident_id + " has been closed")

// Final metrics after closure
log("\nüìä Final Metrics...")
let final_metrics = ir_get_metrics()
log("‚Ä¢ Open incidents: " + final_metrics["open_incidents"])
log("‚Ä¢ Closed incidents: " + final_metrics["closed_incidents"])

log("")
log("==================================================")
log("üéØ Incident Response Automation Complete!")
log("==================================================")

log("\nüõ°Ô∏è Incident Response Capabilities:")
log("‚Ä¢ Automated incident creation and tracking")
log("‚Ä¢ Evidence collection and chain of custody")
log("‚Ä¢ Playbook-driven response automation")
log("‚Ä¢ Real-time incident timeline tracking")
log("‚Ä¢ Comprehensive metrics and reporting")
log("‚Ä¢ Custom playbook creation and execution")

log("\n‚úÖ All incident response features operational!")
log("üöÄ Ready for automated security incident handling!")