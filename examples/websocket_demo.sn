// WebSocket Demo
// Demonstrates WebSocket client functionality in Sentra

// WebSocket echo client
fn test_echo_client() {
    log("Testing WebSocket echo client...")
    
    // Connect to public echo server
    let conn = ws_connect("wss://echo.websocket.org")
    
    if (conn) {
        log("Connected to: " + conn["url"])
        log("Connection ID: " + conn["id"])
        
        // Send a message
        let sent = ws_send(conn["id"], "Hello from Sentra!")
        if (sent) {
            log("Message sent successfully")
            
            // Receive echo response (5 second timeout)
            let response = ws_receive(conn["id"], 5)
            if (response) {
                log("Received echo: " + response)
            }
        }
        
        // Send binary data
        let binary_sent = ws_send_binary(conn["id"], "Binary data test")
        if (binary_sent) {
            log("Binary data sent")
        }
        
        // Ping the server
        let ping_ok = ws_ping(conn["id"])
        if (ping_ok) {
            log("Ping sent successfully")
        }
        
        // Close connection
        ws_close(conn["id"])
        log("Connection closed")
    }
    
    log("")
}

// WebSocket server example
fn test_websocket_server() {
    log("Testing WebSocket server...")
    
    // Create a WebSocket server
    let server = ws_listen("127.0.0.1", 8765)
    
    if (server) {
        log("WebSocket server listening on " + server["address"] + " port " + str(server["port"]))
        log("Server ID: " + server["id"])
        log("")
        
        // Note: In a real application, you would handle client connections
        // This is just a demo of server creation
        
        log("Server created successfully (demo mode - not accepting connections)")
    }
    
    log("")
}

// Multiple connections test
fn test_multiple_connections() {
    log("Testing multiple WebSocket connections...")
    
    let connections = []
    
    // Create multiple connections
    for (let i = 0; i < 3; i = i + 1) {
        let conn = ws_connect("wss://echo.websocket.org")
        if (conn) {
            push(connections, conn)
            log("Created connection " + str(i + 1) + " with ID: " + conn["id"])
        }
    }
    
    // Send messages from each connection
    for (let i = 0; i < len(connections); i = i + 1) {
        let conn = connections[i]
        let message = "Message from connection " + str(i + 1)
        ws_send(conn["id"], message)
        log("Sent: " + message)
    }
    
    // Receive responses
    for (let i = 0; i < len(connections); i = i + 1) {
        let conn = connections[i]
        let response = ws_receive(conn["id"], 2)
        if (response) {
            log("Connection " + str(i + 1) + " received: " + response)
        }
    }
    
    // Close all connections
    for (let i = 0; i < len(connections); i = i + 1) {
        ws_close(connections[i]["id"])
    }
    
    log("All connections closed")
    log("")
}

// Error handling test
fn test_error_handling() {
    log("Testing WebSocket error handling...")
    
    // Test with invalid URL
    let conn = ws_connect("ws://invalid-websocket-url-12345.com")
    if (conn) {
        log("Unexpected: got connection from bad URL")
    } else {
        log("Error handled: Bad URL returned nil")
    }
    
    // Test sending to non-existent connection
    let result = ws_send("invalid_connection_id", "test")
    if (!result) {
        log("Send error handled: Invalid connection returned false")
    }
    
    log("")
}

// Chat client simulation
fn simulate_chat_client() {
    log("Simulating chat client...")
    
    let conn = ws_connect("wss://echo.websocket.org")
    
    if (conn) {
        let messages = [
            "User joined the chat",
            "Hello everyone!",
            "How is everyone doing?",
            "Goodbye!",
            "User left the chat"
        ]
        
        for (let i = 0; i < len(messages); i = i + 1) {
            let msg = messages[i]
            log("[SEND]", msg)
            ws_send(conn["id"], msg)
            
            let response = ws_receive(conn["id"], 1)
            if (response) {
                log("[RECV]", response)
            }
        }
        
        ws_close(conn["id"])
    }
    
    log("")
}

// Main execution
fn main() {
    log("=== Sentra WebSocket Demo ===")
    log("")
    
    test_echo_client()
    test_websocket_server()
    test_multiple_connections()
    test_error_handling()
    simulate_chat_client()
    
    log("=== Demo Complete ===")
}

main()